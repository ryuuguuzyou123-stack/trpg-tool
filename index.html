<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Gemini TRPG Player 2.5 Pro - Romance & Strategy Edition</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;line-height:1.6;margin:0;background:#f0f2f5;color:#1c1e21}
#container{max-width:900px;margin:1rem auto;background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08)}
h1,h2{text-align:center;margin:.2rem 0;color:#222}
#log{height:50vh;overflow-y:auto;border:1px solid #ddd;padding:1rem;margin:.8rem 0;background:#fafafa;border-radius:10px;white-space:pre-wrap}
.bubble{margin:.5rem 0;max-width:86%}
.user{background:#0084ff;color:#fff;margin-left:auto;border-radius:18px 18px 2px 18px;padding:.8rem 1rem}
.gm{background:#e4e6eb;color:#050505;margin-right:auto;border-radius:18px 18px 18px 2px;padding:.8rem 1rem}
.sys{color:#666;font-style:italic;text-align:center}
textarea,input[type="password"]{width:100%;padding:10px;border:1px solid #ccc;border-radius:12px;font-size:15px;resize:vertical;margin:.3rem 0 .6rem}
button{width:100%;padding:12px;background:#0084ff;color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer}
button:hover{background:#0773e0}button:disabled{background:#bbb;cursor:not-allowed}
.settings{background:#f7f7f7;padding:1rem;border-radius:10px;margin:.6rem 0}
#gameDataDisplay{background:#eee;padding:10px;border-radius:8px;max-height:220px;overflow:auto;font-size:.85em}
.row{display:flex;gap:.6rem}.row>*{flex:1}
</style>
</head>
<body>
<div id="container">
<h1>Gemini TRPG Player 2.5 Pro</h1>

<div class="settings">
<h2>設定</h2>
<label for="apiKey">Gemini API Key</label>
<input id="apiKey" type="password" placeholder="AI Studioで取得したキーを入力（保存されません）">
</div>

<div id="log"><div class="sys">ここにセッションのログが表示されます。</div></div>

<div class="row">
<textarea id="userInput" rows="3" placeholder="行動を入力（例：北区倉庫へ向かう）"></textarea>
<button id="sendButton">送信</button>
</div>

<div class="settings">
<h2>ゲームデータ管理</h2>
<div class="row">
<button id="saveButton" style="background:#4caf50;">手動セーブ</button>
<button id="resetButton" style="background:#f44336;">データリセット</button>
</div>
<div class="row" style="margin-top:.6rem">
<button id="exportChapter">章を保存</button>
<button id="importChapter" style="background:#7952b3;">章を読み込み</button>
<input id="importChapterFile" type="file" accept="application/json" style="display:none">
</div>
<div class="row" style="margin-top:.4rem">
<button id="fullBackup" style="background:#555">フルバックアップ</button>
<button id="restoreBackup" style="background:#6c757d">バックアップ復元</button>
<input id="restoreFile" type="file" accept="application/json" style="display:none">
<button id="hardReset" style="background:#dc3545">完全リセット</button>
</div>
<pre id="gameDataDisplay"></pre>
</div>
</div>

<script>
/* ---------- SYSTEM ---------- */
const SYSTEM_PROMPT = String.raw`
# 【SYSTEM】TRPGセッション運用プロンプト（ロマンス・統合）
> 外部検索禁止・露骨描写禁止・親密描写は信頼と尊重の範囲のみ。
> プレイヤー1名＋女性隊員5名。即興より一貫性を優先。状況提示→選択→結果描写。

## 舞台
近未来日本。能力犯罪対策組織「Aegis-Branch」。
主人公＝リンク提供者（Linker）。隊員の能力を“同調儀式（レゾナンス）”で強化。
同調はハグ・手の触れ合い・言葉・呼吸の同期など、合意あるロマンス的接触。

## 登場人物（成人）
1. **メグル**：黒髪ショート。無表情で真面目。冷静な射撃手。触れられると表情が緩む。
2. **ミレー**：金髪ポニテ。頼れる姉タイプ。統制官。紳士的仕草に弱い。
3. **ミィ**：小悪魔後輩。幻術担当。耳元の囁きや可愛い行動に反応。
4. **リョウ**：通信士。静かで理知的。距離を保つ優しさに心を開く。
5. **レイリー**：孤高の工学少女。クールな外面の裏に情熱。何気ない気遣いで揺れる。

## 進行
Mission → Result → Talk → Event。  
ロマンスは「甘さ」と「進度（PG/PG-13/R-Soft）」を確認後に描写。  
全て合意の範囲内で行い、SAVE_DATAで関係値を更新する。
`;

/* ---------- 初期データ ---------- */
const initialGameData = {
  world_setting: "近未来の東京湾岸に位置する『Aegis-Branch第七支部』。",
  player_character: { name: "リンカー", role: "Linker", fatigue: 0, skills:["交渉","指揮","共感"] },
  npcs: [
    { name:"メグル", role:"射撃遊撃", affinity:10, personality:"冷静・律儀", description:"黒髪ショートで無表情。手を取られると照れる。" },
    { name:"ミレー", role:"統制指揮", affinity:35, personality:"厳格・情に厚い", description:"金髪ポニテの姉御肌。礼節に弱い。" },
    { name:"ミィ", role:"幻術潜入", affinity:25, personality:"明るい・茶目っ気", description:"小悪魔的後輩。軽口が多いが優しい。" },
    { name:"リョウ", role:"通信諜報", affinity:15, personality:"無気力・内省的", description:"静かな距離感を保つタイプ。" },
    { name:"レイリー", role:"工学改造", affinity:10, personality:"孤高・情熱的", description:"冷静だが芯に熱いものを秘める。" }
  ],
  session_log:["セッション開始：支部ブリーフィングルームにて。"],
  clocks:{ time:{max:8,cur:0}, alert:{max:6,cur:0} }
};
const STORAGE_KEY="geminiTrpgData";

/* ---------- 要素 ---------- */
const apiKeyInput=document.getElementById("apiKey");
const logDiv=document.getElementById("log");
const userInput=document.getElementById("userInput");
const sendButton=document.getElementById("sendButton");
const saveButton=document.getElementById("saveButton");
const resetButton=document.getElementById("resetButton");
const gameDataDisplay=document.getElementById("gameDataDisplay");
let gameData={};

/* ---------- セーブ関連 ---------- */
function loadGame(){const s=localStorage.getItem(STORAGE_KEY);gameData=s?JSON.parse(s):structuredClone(initialGameData);updateGameDataDisplay();logDiv.innerHTML='<div class="sys">データ読込完了。APIキーを入力して開始。</div>';}
function saveGame(){localStorage.setItem(STORAGE_KEY,JSON.stringify(gameData));updateGameDataDisplay();}
function resetGame(){if(confirm("リセットしますか？")){localStorage.removeItem(STORAGE_KEY);loadGame();}}
function updateGameDataDisplay(){gameDataDisplay.textContent=JSON.stringify(gameData,null,2);}
function appendLog(msg,cls){const d=document.createElement("div");d.className=cls==="sys"?"sys":`bubble ${cls}`;d.textContent=msg;logDiv.appendChild(d);logDiv.scrollTop=logDiv.scrollHeight;}

/* ---------- アーカイブ・バックアップ ---------- */
function chapterExport(){const blob=new Blob([JSON.stringify(gameData,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=`chapter_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.json`;a.click();URL.revokeObjectURL(a.href);appendLog("章を保存しました。","sys");}
function chapterImport(file){const r=new FileReader();r.onload=()=>{try{gameData=JSON.parse(r.result);saveGame();appendLog("章を読み込みました。","sys");}catch(e){appendLog("失敗:"+e.message,"sys");}};r.readAsText(file);}
function fullBackup(){const blob=new Blob([JSON.stringify({ts:Date.now(),data:gameData},null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="full_backup.json";a.click();URL.revokeObjectURL(a.href);appendLog("フルバックアップ完了。","sys");}
function restoreBackup(file){const r=new FileReader();r.onload=()=>{try{const o=JSON.parse(r.result);gameData=o.data||o;saveGame();appendLog("バックアップ復元完了。","sys");}catch(e){appendLog("復元失敗:"+e.message,"sys");}};r.readAsText(file);}
function hardReset(){if(confirm("完全初期化しますか？")){localStorage.clear();gameData=structuredClone(initialGameData);saveGame();appendLog("完全リセット完了。","sys");}}

/* ---------- コンテキスト圧縮 ---------- */
function summarizeState(d){return{world:d.world_setting,player:d.player_character,npcs:d.npcs.slice(0,6),clocks:d.clocks,last:d.session_log.slice(-6)};}

/* ---------- プロンプト ---------- */
function generatePrompt(action){
const s=JSON.stringify(summarizeState(gameData),null,2);
return `${SYSTEM_PROMPT}

# 現在の要約
${s}

# プレイヤーの行動
${action}

# 出力要件
- 状況→選択肢3〜5＋「その他」を提示
- ロマンスは合意あり・上品表現のみ
- 変化時はSAVE_DATAを返す
[SAVE_DATA]
{"session_log.add":"${action}"}
[END_SAVE_DATA]`;
}

/* ---------- SAVE_DATA ---------- */
function applySaveData(text){const m=text.match(/\[SAVE_DATA\]([\s\S]*?)\[END_SAVE_DATA\]/);if(!m)return;try{const u=JSON.parse(m[1].trim());for(const k in u){const v=u[k];const keys=k.split(".");const op=keys.at(-1);const isAdd=op==="add",isRemove=op==="remove";const path=isAdd||isRemove?keys.slice(0,-1):keys;let t=gameData;for(let i=0;i<path.length-1;i++){const kk=path[i];t[kk]??={};t=t[kk];}const last=path.at(-1);if(isAdd||isRemove){const arr=t[last];if(Array.isArray(arr)){if(isAdd)arr.push(v);else{const i=arr.indexOf(v);if(i>-1)arr.splice(i,1);}}}else{t[last]=v;}}}catch{appendLog("SAVE_DATA解析失敗","sys");}}

/* ---------- Gemini 呼び出し ---------- */
const MODEL="gemini-2.5-pro";
const API_BASE="https://generativelanguage.googleapis.com/v1beta";
async function callGemini(apiKey,prompt){
const url=`${API_BASE}/models/${MODEL}:generateContent?key=${encodeURIComponent(apiKey)}`;
const body={contents:[{parts:[{text:prompt}]}],generationConfig:{temperature:0.9,maxOutputTokens:8192}};
const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
let d;try{d=await r.json();}catch(e){throw new Error(`レスポンス解析失敗:${e.message}`);}
if(!r.ok)throw new Error(`HTTP${r.status}:${JSON.stringify(d)}`);
const cand=d.candidates?.[0];if(!cand)throw new Error("応答なし");
const parts=cand.content?.parts??[];if(!Array.isArray(parts))throw new Error("parts不明");
return parts.map(p=>p.text??"").join("").trim();
}

/* ---------- ローカル /roll ---------- */
function tryLocalCommand(t){const m=t.match(/^\/roll\s+(\d+)d(\d+)([+\-]\d+)?$/i);if(m){const n=Math.min(20,parseInt(m[1]));const f=Math.min(100,parseInt(m[2]));const mod=m[3]?parseInt(m[3]):0;let rolls=[],sum=0;for(let i=0;i<n;i++){const r=1+Math.floor(Math.random()*f);rolls.push(r);sum+=r;}const total=sum+mod;appendLog(`/roll ${n}d${f}${mod>=0?`+${mod}`:mod} → [${rolls.join(", ")}] = ${total}`,"sys");return true;}return false;}

/* ---------- 送信処理 ---------- */
async function handleSend(){
const a=userInput.value.trim(),k=apiKeyInput.value.trim();
if(!a){alert("行動を入力してください。");return;}
if(tryLocalCommand(a)){userInput.value="";return;}
if(!k){alert("APIキーを入力してください。");return;}
appendLog("> "+a,"user");
userInput.value="";sendButton.disabled=true;sendButton.textContent="生成中...";
try{const p=generatePrompt(a);const txt=await callGemini(k,p);const clean=txt.replace(/\[SAVE_DATA\][\s\S]*?\[END_SAVE_DATA\]/,"").trim();appendLog(clean,"gm");applySaveData(txt);saveGame();}
catch(e){appendLog("エラー:"+e.message,"sys");}
finally{sendButton.disabled=false;sendButton.textContent="送信";}
}

/* ---------- イベント ---------- */
sendButton.onclick=handleSend;
saveButton.onclick=()=>{saveGame();appendLog("手動セーブしました。","sys");};
resetButton.onclick=resetGame;
userInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();handleSend();}});
document.getElementById("exportChapter").onclick=chapterExport;
document.getElementById("importChapter").onclick=()=>importChapterFile.click();
document.getElementById("importChapterFile").onchange=e=>{if(e.target.files[0])chapterImport(e.target.files[0]);};
document.getElementById("fullBackup").onclick=fullBackup;
document.getElementById("restoreBackup").onclick=()=>restoreFile.click();
document.getElementById("restoreFile").onchange=e=>{if(e.target.files[0])restoreBackup(e.target.files[0]);};
document.getElementById("hardReset").onclick=hardReset;
loadGame();
</script>
</body>
</html>
